---
title: "Projekt"
author: "Damian Szkudlarek"
date: "17 11 2020"
output:
  html_document:
    theme: spacelab
    highlight: kate
    toc: yes
    toc_float: true 
    df_print: paged
---
5.Sekcję podsumowującą rozmiar zbioru i podstawowe statystyki.
6.Szczegółową analizę wartości atrybutów.
7.Sekcję sprawdzającą korelacje między zmiennymi; sekcja ta powinna zawierać jakąś formę graficznej prezentacji korelacji.
9.Sekcję próbującą stworzyć klasyfikator przewidujący czy dany pacjent przeżyje (w tej sekcji należy wykorzystać wiedzę z                   pozostałych punktów oraz wykonać dodatkowe czynności, które mogą poprawić trafność predykcji); dobór parametrów modelu oraz                 oszacowanie jego skuteczności powinny zostać wykonane za pomocą techniki podziału zbioru na dane uczące, walidujące i testowe;trafność     klasyfikacji powinna zostać oszacowana na podstawie kliku wybranych (i uzasadnionych) miar oceny klasyfikacji.
10.Analizę ważności atrybutów najlepszego znalezionego modelu.
11.Dodatkowo punktowane będzie wykonanie analizy typowej dla danych klinicznych, np. regresji logistycznej wraz z wzięciem pod uwagę czynników zakłócających (ang. confounding factors) lub regresji Coxa (ang. Cox Proportional-Hazards Model).
```{r include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r setup, warning = FALSE, message=FALSE}
library(openxlsx)
library(skimr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(gganimate)
library(RColorBrewer)
```

```{r data, cache=TRUE}
df <- read.xlsx(xlsxFile="data\\wuhan_blood_sample_data_Jan_Feb_2020.xlsx", fillMergedCells = TRUE, sheet = 1) %>%
  rename(NT_proBNP = `Amino-terminal.brain.natriuretic.peptide.precursor(NT-proBNP)`)
df$RE_DATE = convertToDateTime(df$RE_DATE)
df$Admission.time = convertToDateTime(df$Admission.time)
df$Discharge.time = convertToDateTime(df$Discharge.time)
```

```{r warning=FALSE}
set.seed(131836)
```

# Opis danych
```{r warning=FALSE}
my_skim <- skim_with(numeric = sfl(hist = NULL, p25=NULL,p50=NULL))
my_skim(df)
```
## Liczebność pacjentów ze względu na płeć
```{r echo=FALSE}
df %>% select(PATIENT_ID, gender) %>% distinct() %>% mutate(gender = ifelse(gender==1, "mężczyzna", "kobieta")) %>%
  rename(`Płeć` = gender) %>%
  ggplot(aes(x=`Płeć`, fill=`Płeć`)) +
    geom_bar(stat="count", width = 0.6) +
    ylab("przypadki") +
    stat_count(geom = "text", colour = "white", size = 4,
                aes(label = ..count..), position=position_stack(vjust=0.5))+
    scale_x_discrete(breaks=NULL) +xlab("")
```

## Śmiertelność wśród płci
```{r echo=FALSE}
df %>% select(PATIENT_ID, gender, outcome)  %>% distinct() %>% mutate(gender = ifelse(gender==1, "mężczyzna", "kobieta"), outcome = ifelse(outcome==1, "martwi", "żyjący")) %>%
  rename(`Płeć` = gender) %>%
  ggplot(aes(x=`Płeć`, fill=`Płeć`)) +
    geom_bar(stat="count", width = 0.6) +
    ylab("przypadki") +
    stat_count(geom = "text", colour = "white", size = 4,
                aes(label = ..count..), position=position_stack(vjust=0.5))+
    facet_grid( . ~outcome)+
    scale_x_discrete(breaks=NULL) +xlab("")
```

## Rozkład wieku wśród płci
```{r echo=FALSE}
df %>% select(PATIENT_ID, age, gender)  %>% distinct() %>% mutate(gender = ifelse(gender==1, "mężczyzna", "kobieta")) %>%
  rename(`Płeć` = gender) %>%
  ggplot(aes(age, fill=`Płeć`, alpha=0.15)) + 
    geom_density() +
    scale_x_continuous(breaks = scales::pretty_breaks(n = 7)) +
    geom_vline(
      aes(xintercept = mean(age)),
      color = "black",
      linetype = "dashed",
      size = 1)+
    xlab("wiek")+
    ylab("gęstość")
```


## Liczba śmiertelnych przypadków wśród grup wiekowych
```{r echo=FALSE}
df %>% filter(outcome==1) %>% select(PATIENT_ID, age, gender)  %>% distinct() %>% select(-PATIENT_ID)  %>% 
  mutate(
    gender = ifelse(gender==1, "mężczyzna", "kobieta"),
    bin = cut(age, quantile(age, probs=seq(0, 1, by=0.2)), labels=c("19-61","62-66","67-71","72-79","80-95"), include.lowest = TRUE)) %>%
  rename(`Płeć` = gender) %>%
  ggplot(aes(x=`Płeć`, fill=`Płeć`)) + 
    geom_bar()+
    ylab("przypadki") +
    facet_grid(.~bin)+
    stat_count(geom = "text", colour = "white", size = 4,
                aes(label = ..count..), position=position_stack(vjust=0.5))+
    scale_x_discrete(breaks=NULL) +xlab("")
```


# Wykres zmienny w czasie
```{r time chart, cache=TRUE, echo=FALSE, warning = FALSE, message=FALSE}
p <- df %>%
  select(RE_DATE, gender, Lactate.dehydrogenase) %>%
  drop_na() %>%
  mutate(RE_DATE = as.Date(RE_DATE))  %>%
  group_by(RE_DATE, gender) %>%
  summarise(Lactate.dehydrogenase = mean(Lactate.dehydrogenase)) %>%
  mutate(gender = ifelse(gender==1, "mężczyzna", "kobieta"))

  
p %>%
  rename(`Płeć` = gender) %>%
  ggplot(aes(y=Lactate.dehydrogenase, x=RE_DATE, color = `Płeć`)) +
    geom_line(size=1.05) +
    scale_fill_manual(values=c("#E69F00", "#56B4E9"))+
    labs(x = "data", y = "dehydrogenaza mleczanowa (LDH)") +
    ggtitle("Średni poziom LDH wśród pacjentów badanych w styczniu i lutym") + 
    theme_bw(base_size = 12) +
    theme(legend.position = "top")+
    scale_x_date(breaks = scales::breaks_width("7 days")) +
    scale_y_continuous(breaks = scales::pretty_breaks(n = 7)) +
    transition_reveal(RE_DATE)

```

# Korelacja między atrybutami

```{r echo=FALSE, warning = FALSE, message=FALSE}
cols = colnames(select_if(df, is.numeric))
corrs <- data.frame(col1=character(), col2=character(), coef=numeric())
i <- 0
for (col1 in cols) {
  i <- i+1
  for(col2 in cols[-(1:i)]){
    tryCatch(
       corrs <- rbind(corrs, list(col1,col2,cor.test(df[,col1], df[,col2], method = 'pearson')$estimate)),
       error=function(err) corrs<-rbind(corrs, list(col1,col2,-69.0))
    )
  }
}
names(corrs) <- c("col1","col2","coef")
corrs <- corrs %>%
  filter(coef<=0.999 & coef>0.85)%>%
  group_by(col1,col2)%>%
  mutate(rows=df[c(col1,col2)]%>%drop_na()%>%nrow())%>%
  filter(rows<6000)%>%
  ungroup() %>%
  slice_max(rows,n=10)%>% 
  slice_max(coef,n=7)

```

```{r echo=FALSE,message=FALSE, warning=FALSE}
all_pairs <- corrs %>% group_by(col1,col2)%>% mutate(pairs=list(c(col1,col2,round(coef, 2))), .keep="used") %>% ungroup() %>% select(pairs)
all_pairs <- as.list(all_pairs)[[1]]
for (pair in all_pairs){
  corr_df <- df %>%
    select(age, pair[1], pair[2]) %>%
    drop_na() %>%
    distinct()
  tmp_plt <- corr_df %>%
    ggplot(aes(y=corr_df[,pair[1]], x=corr_df[,pair[2]], color = age)) +
    geom_point()+
    geom_smooth(colour="red", size=0.4) +
    labs(x = pair[2], y = pair[1]) +
    ggtitle(paste(
      "Atrybuty ",
      gsub('\\.',' ',pair[2]),
      " i ",
      gsub('\\.',' ',pair[1]),
      "\nWspółczynnik korelacji:", pair[3], sep = " ")
      ) + 
    theme_bw(base_size = 12)
  print(tmp_plt)
}
```

```{r}
df %>% select(PATIENT_ID, outcome, Lactate.dehydrogenase) %>% drop_na() %>% group_by(PATIENT_ID) %>% mutate(LDH=mean(Lactate.dehydrogenase)) %>% ungroup() %>% select(PATIENT_ID, outcome, LDH) %>% distinct() %>% group_by(outcome) %>% mutate(LDH_mean = mean(LDH), outcome = ifelse(outcome==1, "martwi", "żyjący")) %>% ungroup() %>%
  ggplot(aes(x=LDH)) +
  geom_histogram(binwidth = 50)+
    geom_vline(
      aes(xintercept = LDH_mean),
      color = "black",
      linetype = "dashed",
      size = 1)+
  facet_wrap(.~outcome)+
  xlab("dehydrogenaza mleczanowa (LDH)")+
  ylab("przypadków")
```

```{r}
df %>% select(PATIENT_ID, outcome, `(%)lymphocyte`) %>% drop_na() %>% group_by(PATIENT_ID) %>% mutate(limfocyty=mean(`(%)lymphocyte`)) %>% ungroup() %>% select(PATIENT_ID, outcome, limfocyty) %>% distinct() %>% group_by(outcome) %>% mutate(mean = mean(limfocyty), outcome = ifelse(outcome==1, "martwi", "żyjący")) %>% ungroup() %>%
  ggplot(aes(x=limfocyty)) +
  geom_histogram(binwidth = 2)+
    geom_vline(
      aes(xintercept = mean),
      color = "black",
      linetype = "dashed",
      size = 1)+
  facet_wrap(.~outcome)+
  xlab("limfocyty (%)")+
  ylab("przypadków")
```

```{r}
df %>% select(PATIENT_ID, outcome, `High.sensitivity.C-reactive.protein`) %>% drop_na() %>% group_by(PATIENT_ID) %>% mutate(hs_CRP=mean(`High.sensitivity.C-reactive.protein`)) %>% ungroup() %>% select(PATIENT_ID, outcome, hs_CRP) %>% distinct() %>% group_by(outcome) %>% mutate(mean = mean(hs_CRP), outcome = ifelse(outcome==1, "martwi", "żyjący")) %>% ungroup() %>%
  ggplot(aes(x=hs_CRP)) +
  geom_histogram(binwidth = 9)+
    geom_vline(
      aes(xintercept = mean),
      color = "black",
      linetype = "dashed",
      size = 1)+
  facet_wrap(.~outcome)+
  xlab("hs-CRP")+
  ylab("przypadków")
```